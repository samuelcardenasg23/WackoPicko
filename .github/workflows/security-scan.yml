# Security Analysis with Fluid Attacks
name: Security Analysis

# Define when this workflow should run
on:
  # Run on every push to main branch
  push:
    branches: [main, master]
  # Run on every pull request to main branch
  pull_request:
    branches: [main, master]
  # Allow manual execution of the workflow
  workflow_dispatch:

# Define the jobs that will run
jobs:
  # Job for security scanning
  security-scan:
    # Use Ubuntu as the runner environment
    runs-on: ubuntu-latest

    # Define the steps for this job
    steps:
      # Step 1: Download the source code to the runner
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Run Fluid Attacks scan (CSV output)
      - name: Skims scan (CSV output)
        uses: docker://ghcr.io/fluidattacks/makes/amd64:latest
        with:
          args: m gitlab:fluidattacks/universe@trunk /skims scan --output results.csv .

      # Step 3: Run Fluid Attacks scan (JSON output)
      - name: Skims scan (JSON output)
        uses: docker://ghcr.io/fluidattacks/makes/amd64:latest
        with:
          args: m gitlab:fluidattacks/universe@trunk /skims scan --output results.json --format json .

      # Step 4: Upload CSV results
      - name: Upload CSV results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-csv
          path: results.csv
          retention-days: 30

      # Step 5: Upload JSON results
      - name: Upload JSON results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-json
          path: results.json
          retention-days: 30
