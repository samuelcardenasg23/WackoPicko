# Security Analysis Pipeline with Fluid Attacks Skims
# This workflow runs security scans on every push and pull request
name: Security Analysis

# Define when this workflow should run
on:
  # Run on every push to main branch
  push:
    branches: [main, master]
  # Run on every pull request to main branch
  pull_request:
    branches: [main, master]
  # Allow manual execution of the workflow
  workflow_dispatch:

# Define the jobs that will run
jobs:
  # Job for security scanning
  security-scan:
    # Use Ubuntu as the runner environment
    runs-on: ubuntu-latest

    # Define the steps for this job
    steps:
      # Step 1: Download the source code to the runner
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Get full history for better analysis
          fetch-depth: 0

      # Step 2: Run Fluid Attacks Skims security scanner
      - name: Run Skims Security Analysis
        # Use the official Fluid Attacks Makes image (which includes Skims)
        uses: docker://ghcr.io/fluidattacks/makes/amd64:latest
        with:
          # Use makes to run skims scan with our config file
          args: m gitlab:fluidattacks/universe@trunk /skims scan ./.skims.yaml

      # Step 3: Upload scan results as artifacts
      - name: Upload Skims Results
        uses: actions/upload-artifact@v4
        # Always upload results, even if scan finds vulnerabilities
        if: always()
        with:
          # Name of the artifact
          name: skims-security-report
          # Look for any CSV files generated by Skims
          path: "*.csv"
          # Keep artifacts for 30 days
          retention-days: 30

      # Step 4: Upload any JSON results
      - name: Upload JSON Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: skims-json-report
          path: "*.json"
          retention-days: 30

      # Step 5: Comment results on Pull Request (optional)
      - name: Comment PR with results
        # Only run on pull requests
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Read the results and comment on PR
            const fs = require('fs');
            try {
              // Look for CSV files in the current directory
              const files = fs.readdirSync('.');
              const csvFiles = files.filter(file => file.endsWith('.csv'));
              const jsonFiles = files.filter(file => file.endsWith('.json'));
              
              if (csvFiles.length > 0 || jsonFiles.length > 0) {
                const comment = `
                ## üîç Security Scan Results
                
                Skims security analysis has been completed.
                
                üìä **Files generated:**
                ${csvFiles.length > 0 ? `- CSV Reports: ${csvFiles.join(', ')}` : ''}
                ${jsonFiles.length > 0 ? `- JSON Reports: ${jsonFiles.join(', ')}` : ''}
                
                üì• **Download results**: [Security Report Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
                
                ‚ö†Ô∏è **Important**: Please review all security findings before merging.
                `;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not read results:', error);
            }
